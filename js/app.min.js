var transaction={};function getBalance(e,a,t){var o=a.parents(".form-group");steem.api.getAccounts([e],function(e,a){if(!e&&a.length){if(o.removeClass("has-error").addClass("has-success"),t){var s=a[0].balance.split(" "),r=a[0].sbd_balance.split(" ");o.find(".help-block").remove(),o.append('<p class="help-block">User has '+a[0].balance+" and "+a[0].sbd_balance+"</p>"),null==$("#amount").data("maxSteem")&&$("#amount").data({maxSteem:s[0],maxSbd:r[0]})}}else o.removeClass("has-success").addClass("has-error")})}$.getJSON("agents.json",function(e){var a=e.map(function(e){return e.name});steem.api.getAccounts(a,function(a,t){a||$.each(t,function(a,t){$("#agent").append('<option value="'+t.name+'" data-fee="'+e[a].fee+'">'+t.name+" ("+calcRep(t.reputation)+") Fee: "+e[a].fee+"</option>")})})});var timeout=null;function calcRep(e){return(Math.max(Math.log10(Math.abs(parseInt(e)))-9,0)*(parseInt(e)>0?1:-1)*9+25).toFixed(1)}function niceDate(e){return new Date(e+"Z").toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}function getUrlParam(e){var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.href);return a&&a[1]||void 0}if($("#sender, #recipient").on("input",function(){var e=$(this);clearTimeout(timeout),timeout=setTimeout(function(){getBalance(e.val(),e,!0)},500)}),$("#amount").keyup(function(){var e,a=$(this),t=a.parents(".form-group");"STEEM"===$("#currency option:selected").val()?e=parseFloat(a.val())>parseFloat(a.data("maxSteem"))?"Maximum of "+a.data("maxSteem")+" STEEM can be sent after agent fee.":"":"SBD"===$("#currency option:selected").val()&&(e=parseFloat(a.val())>parseFloat(a.data("maxSbd"))?"Maximum of "+a.data("maxSbd")+" SBD can be sent after agent fee.":""),""!=e?(t.find(".help-block").remove(),t.removeClass("has-success").addClass("has-error"),t.append('<p class="help-block">'+e+"</p>")):(t.find(".help-block").remove(),t.removeClass("has-error").addClass("has-success"))}),$("#amount, #fee").focusout(function(){var e=$(this).parents(".form-group");if(/^[+-]?\d+(\.\d+)?$/.test($(this).val())){var a=parseFloat($(this).val()).toFixed(3);$(this).val(a),e.find(".help-block").remove()}else e.find(".help-block").remove(),e.removeClass("has-success").addClass("has-error"),e.append('<p class="help-block">Please enter a number.</p>')}),$("#currency").change(function(e){$("#amount").keyup()}),$("#agent").change(function(e){var a=parseFloat($("#agent option:selected").data("fee")).toFixed(3),t=parseFloat($("#amount").data("maxSteem"))-a,o=parseFloat($("#amount").data("maxSbd"))-a;$("#amount").data({maxSteem:t,maxSbd:o}),$("#fee").val(a)}),timeout=null,$("#active_key").on("input",function(){var e=$(this),a=e.parents(".form-group");clearTimeout(timeout),timeout=setTimeout(function(){var t=[];""!=$("#sender").val()?steem.auth.isWif(e.val())?steem.api.getAccounts([$("#sender").val()],function(t,o){!t&&o.length&&(steem.auth.wifIsValid(e.val(),o[0].active.key_auths[0][0])?(a.find(".help-block").remove(),a.removeClass("has-error").addClass("has-success")):(a.find(".help-block").remove(),a.removeClass("has-success").addClass("has-error"),a.append('<p class="help-block">This WIF is not yours, please <a href="https://steemit.com/@'+$("#sender").val()+'/permissions">click here</a> to find yours.</p>')))}):t="Please enter a valid Active WIF.":t="Please fill out sender name first.",t.length>0?(a.find(".help-block").remove(),a.removeClass("has-success").addClass("has-error"),a.append('<p class="help-block">'+t+"</p>")):(a.find(".help-block").remove(),a.removeClass("has-error").addClass("has-success"))},500)}),$("#escrowTransfer").submit(function(e){var a=$("#sender").val(),t=$("#recipient").val(),o=$("#active_key").val(),s=$("#agent").val(),r=parseInt(89999999*Math.random()+1e7),n="0.000 SBD",i="0.000 STEEM",l=parseFloat($("#amount").val()).toFixed(3),d=$("#currency option:selected").val(),c=parseFloat($("#fee").val()).toFixed(3)+" "+d,p=JSON.stringify({terms:$("#terms").val()});"STEEM"==d?i=l+" "+d:n=l+" "+d,steem.api.getDynamicGlobalProperties(function(e,l){var d=new Date(l.time+"Z");d.setMinutes(d.getMinutes()+60*parseInt($("#deadline").val())-1);var u=new Date(l.time+"Z");u.setHours(u.getHours()+parseInt($("#expiration").val())),steem.broadcast.escrowTransfer(o,a,t,s,r,n,i,c,d,u,p,function(e,t){if(!e&&t.ref_block_num){var o=window.location.href+"?escrowId="+r+"&sender="+a;$("#alert").addClass("alert-success").append("Escrow request has be created successfully. ID:"+r+'<br>Control Panel URL: <a href="'+o+'">'+o+"</a><br>Send this link to receiver and escrow agent for their approval.").fadeIn()}else console.error(e),void 0!==e.payload?$("#alert").addClass("alert-danger").append(e.payload.error.message.replace(/([^>])\n/g,"$1<br><br>")).fadeIn():$("#alert").addClass("alert-danger").append(e).fadeIn()})}),e.preventDefault()}),void 0===getUrlParam("escrowId"))$("#escrowTransfer").removeClass("hidden").fadeIn("slow");else{var escrowId=getUrlParam("escrowId"),sender=getUrlParam("sender");Math.floor(escrowId)==escrowId&&$.isNumeric(escrowId)&&steem.api.getEscrow(sender,escrowId,function(e,a){if(a){$("#escrowControlPanel").removeClass("hidden").fadeIn("slow");var t=a.escrow_id,o=a.agent,s=a.agent_approved;disputed=a.disputed,escrow_expiration=a.escrow_expiration,from=a.from,id=a.id,pending_fee=a.pending_fee,ratification_deadline=a.ratification_deadline,sbd_balance=a.sbd_balance,steem_balance=a.steem_balance,to=a.to,to_approved=a.to_approved,escrow_status="",escrow_amount="",escrow_terms="",steem.api.getAccountHistory(from,-1,100,function(e,a){!e&&a.length&&($.each(a,function(e,a){"escrow_transfer"==a[1].op[0]&&parseInt(a[1].op[1].escrow_id)==parseInt(t)&&(escrow_terms=$.parseJSON(a[1].op[1].json_meta))}),$("#escrow_terms").html(void 0!==escrow_terms.terms?escrow_terms.terms:JSON.stringify(escrow_terms)))}),"0.000 SBD"!==sbd_balance?escrow_amount=sbd_balance:escrow_amount=steem_balance,$("#receiverApprove").data({user:to,action:"approval",approve:1}),$("#receiverDisapprove").data({user:to,action:"approval",approve:0}),$("#agentApprove").data({user:o,action:"approval",approve:1}),$("#agentDisapprove").data({user:o,action:"approval",approve:0}),$("#senderDispute").data({user:from,action:"dispute",dispute:1}),$("#receiverDispute").data({user:to,action:"dispute",dispute:1}),$("#senderRelease").data({user:from,action:"release",release:to}),$("#receiverRelease").data({user:to,action:"release",release:from}),$("#agentRelease").data({user:o,action:"agent_release",from:from,to:to}),$("#receiverApprove, #receiverDisapprove, #agentApprove, #agentDisapprove, #agentRelease, #senderRelease, #receiverRelease, #senderDispute, #receiverDispute").hide();var r="",n="",i="";steem.api.getDynamicGlobalProperties(function(e,a){var t=new Date(escrow_expiration+"Z");s||to_approved?s&&!to_approved?($("#receiverApprove, #receiverDisapprove").show(),r="No action needed.",i="No action needed.",escrow_status="Waiting for recipient's approval."):!s&&to_approved?($("#agentApprove, #agentDisapprove").show(),escrow_status="Waiting for agent's approval.",r="No action needed.",n="No action needed."):disputed?($("#agentRelease").show(),escrow_status="Transaction has been disputed.",r="No action needed. Wait for agent to make decision.",n="No action needed. Wait for agent to make decision."):t<a.time?($("#senderRelease, #receiverRelease").show(),escrow_status="Escrow has been expired.",i="No action needed."):($("#senderDispute, #receiverDispute, #senderRelease, #receiverRelease").show(),escrow_status="Transaction has been approved.",i="No action needed."):($("#receiverApprove, #receiverDisapprove, #agentApprove, #agentDisapprove").show(),escrow_status="Waiting for agent and recipient's approval.",r="No action needed."),$("#sender_action").text(r),$("#receiver_action").text(n),$("#agent_action").text(i),$("#escrow_status").text(escrow_status),$("#blockchain_date").text(niceDate(a.time))}),$("#escrow_id").text(t),$("#escrow_amount").text(escrow_amount),$("#agent_fee").text(pending_fee).append('<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-placement="right" title="After approval fee will be transferred to agent."></span>'),$("#approval_deadline").text(niceDate(ratification_deadline)).append('<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-placement="right" title="Receipient and agent should approve the escrow before this date."></span>'),$("#expiration_date").text(niceDate(escrow_expiration)).append('<span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-placement="right" title="Escrow warranty by the agent will be over after this date."></span>'),$("#sender_name").append('<a href="https://steemit.com/@'+from+'">@'+from+"</a>"),$("#receiver_name").append('<a href="https://steemit.com/@'+to+'">@'+to+"</a>"),$("#agent_name").append('<a href="https://steemit.com/@'+o+'">@'+o+"</a>"),transaction.submitApprove=function(e,a,s,r){steem.broadcast.escrowApprove(a,from,to,o,e,t,s,function(e,a){r()})},transaction.submitRelease=function(e,a,s){steem.broadcast.escrowRelease(a,from,to,o,e,e==from?to:from,t,sbd_balance,steem_balance,function(e,a){s()})},transaction.submitExpired=function(e,a,s){steem.broadcast.escrowRelease(a,from,to,o,e,e==from?from:to,t,sbd_balance,steem_balance,function(e,a){s()})},transaction.submitDispute=function(e,a,s){steem.broadcast.escrowDispute(a,from,to,o,e,t,function(e,a){s()})},transaction.submitEscrow=function(e,a,s,r){steem.broadcast.escrowRelease(a,from,to,o,e,s,t,sbd_balance,steem_balance,function(e,a){r()})}}else e&&console.log(e),$("#alert").addClass("alert-warning").append("There was a problem loading the transaction. Either it doesn't exists or completed or receiver or agent hadn't approved the transaction. Please contact other parties and create a new transaction.")})}$("#actionForm").submit(function(e){e.preventDefault();var a=$("#user").val(),t=$("#wif").val(),o=$("#action").val(),s=$("#action_value").val(),r=$("#release_to").val();"approval"===o?typeof(s=Boolean(Number(s)))==typeof!0&&transaction.submitApprove(a,t,s,function(e,a){$("#actionModal").modal("hide"),location.reload()}):"dispute"===o?transaction.submitDispute(a,t,function(e,a){$("#actionModal").modal("hide"),location.reload()}):"release"===o?transaction.submitRelease(a,t,function(e,a){$("#actionModal").modal("hide"),location.reload()}):"agent_release"===o&&transaction.submitEscrow(a,t,r,function(e,a){$("#actionModal").modal("hide"),location.reload()})}),$("#actionModal").on("show.bs.modal",function(e){var a=$(e.relatedTarget),t=a.data("user"),o=a.data("action"),s=$(this);s.find(".modal-body input#action").val(o),s.find(".modal-body input#user").val(t);var r=s.find('button[type="submit"]');if("approval"===o)0==a.data("approve")?(s.find(".modal-title").text("Are you sure you want to disapprove this transaction?"),r.addClass("btn-danger").text("Dispprove")):(s.find(".modal-title").text("Are you sure you want to approve this transaction?"),r.addClass("btn-success").text("Approve")),s.find(".modal-body input#action_value").val(a.data("approve"));else if("dispute"===o)s.find(".modal-title").text("Are you sure you want to dispute this transaction?"),r.addClass("btn-danger").text("Dispute");else if("release"===o){var n=a.data("release");s.find(".modal-title").html('Are you sure you want to release the fund to <a href="https://steemit.com/@'+n+'">@'+n+"</a>?"),r.addClass("btn-info").text("Release")}else if("agent_release"===o){s.find(".modal-title").text("Are you sure you want to release the fund?");var i=a.data("to"),l=a.data("from");s.find(".modal-body").append('<div class="form-group"><label>Release To</label><br><div class="radio"><label><input type="radio" id="release_to" name="release_to" value="'+i+'">Reciever ('+i+')</div></label><div class="radio"><label><input type="radio" id="release_to" name="release_to" value="'+l+'">Sender ('+l+")</label></div></div>"),r.addClass("btn-info").text("Release")}}),$("#actionModal").on("hidden.bs.modal",function(e){var a=$(this);a.find(".modal-body input#action").val(""),a.find(".modal-body input#user").val(""),a.find(".modal-body input#wif").val(""),a.find(".modal-body .has-success").removeClass("has-success"),a.find(".modal-body .has-error").removeClass("has-error"),a.find(".modal-body p.help-block").remove(),a.find('button[type="submit"]').removeClass("btn-success btn-danger btn-info")}),$(document).ready(function(){$("body").tooltip({selector:"[data-toggle=tooltip]"})});